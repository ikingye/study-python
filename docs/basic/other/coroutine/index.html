<!DOCTYPE html>
<html lang="en" dir=>

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Python 协程 #   执行效率高  子程序切换不是线程切换，而是由程序自身控制，因此，没有线程切换的开销，和多线程比，线程数量越多，协程的性能优势就越明显。 不需要多线程的锁机制，因为只有一个线程，也不存在同时写变量冲突，在协程中控制共享资源不加锁，只需要判断状态就好了    因为协程是一个线程执行，那怎么利用多核 CPU 呢？ 最简单的方法是多进程 &#43; 协程，既充分利用多核，又充分发挥协程的高效率，可获得极高的性能。
子程序就是协程的一种特例 #  Donald Knuth 的一句话总结协程的特点：
“子程序就是协程的一种特例。”
gevent #  Python 通过 yield 提供了对协程的基本支持，但是不完全。而第三方的 gevent 为 Python 提供了比较完善的协程支持。
gevent 是第三方库，通过 greenlet 实现协程，其基本思想是：
当一个 greenlet 遇到 IO 操作时，比如访问网络，就自动切换到其他的 greenlet，等到 IO 操作完成，再在适当的时候切换回来继续执行。由于 IO 操作非常耗时，经常使程序处于等待状态，有了 gevent 为我们自动切换协程，就保证总有 greenlet 在运行，而不是等待 IO。
由于切换是在 IO 操作时自动完成，所以 gevent 需要修改 Python 自带的一些标准库，这一过程在启动时通过 monkey patch 完成：
from gevent import monkey; monkey.patch_socket() import gevent def f(n): for i in range(n): print gevent.">
<meta name="theme-color" content="#FFFFFF"><meta property="og:title" content="协程" />
<meta property="og:description" content="Python 协程 #   执行效率高  子程序切换不是线程切换，而是由程序自身控制，因此，没有线程切换的开销，和多线程比，线程数量越多，协程的性能优势就越明显。 不需要多线程的锁机制，因为只有一个线程，也不存在同时写变量冲突，在协程中控制共享资源不加锁，只需要判断状态就好了    因为协程是一个线程执行，那怎么利用多核 CPU 呢？ 最简单的方法是多进程 &#43; 协程，既充分利用多核，又充分发挥协程的高效率，可获得极高的性能。
子程序就是协程的一种特例 #  Donald Knuth 的一句话总结协程的特点：
“子程序就是协程的一种特例。”
gevent #  Python 通过 yield 提供了对协程的基本支持，但是不完全。而第三方的 gevent 为 Python 提供了比较完善的协程支持。
gevent 是第三方库，通过 greenlet 实现协程，其基本思想是：
当一个 greenlet 遇到 IO 操作时，比如访问网络，就自动切换到其他的 greenlet，等到 IO 操作完成，再在适当的时候切换回来继续执行。由于 IO 操作非常耗时，经常使程序处于等待状态，有了 gevent 为我们自动切换协程，就保证总有 greenlet 在运行，而不是等待 IO。
由于切换是在 IO 操作时自动完成，所以 gevent 需要修改 Python 自带的一些标准库，这一过程在启动时通过 monkey patch 完成：
from gevent import monkey; monkey.patch_socket() import gevent def f(n): for i in range(n): print gevent." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://ikingye.github.io/study-python/docs/basic/other/coroutine/" />
<meta property="article:modified_time" content="2020-07-14T23:41:45+08:00" />
<title>协程 | Python 学习笔记</title>
<link rel="manifest" href="/study-python/manifest.json">
<link rel="icon" href="/study-python/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="/study-python/book.min.ce0f902f11a0f7675f61f65c2edd624054c6ccc1465f48c5761565b68b9daa75.css" integrity="sha256-zg&#43;QLxGg92dfYfZcLt1iQFTGzMFGX0jFdhVltoudqnU=">
<script defer src="/study-python/en.search.min.056dd35262f318c1bfbbaf7ca62ef676579891255b65a6d0a054e1f69b844a3b.js" integrity="sha256-BW3TUmLzGMG/u698pi72dleYkSVbZabQoFTh9puESjs="></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

  
</head>

<body dir=>
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      
  <nav>
<h2 class="book-brand">
  <a href="/study-python"><span>Python 学习笔记</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>



<ul>
  <li><a href="https://kingye.me" target="_blank" rel="noopener noreferrer">博客</a></li>
  <li><a href="https://cdn.jsdelivr.net/gh/ikingye/imagehost/picgo/20200417021727.png" target="_blank" rel="noopener noreferrer">公众号</a></li>
  <li><a href="https://github.com/ikingye" target="_blank" rel="noopener noreferrer">Github</a></li>
  <li><a href="https://weibo.com/kingyip15215" target="_blank" rel="noopener noreferrer">微博</a></li>
  <li><a href="https://www.zhihu.com/people/wutongyip" target="_blank" rel="noopener noreferrer">知乎</a></li>
</ul>
<hr />








  



  
  
  
  

  
  <ul>
    
      
        <li>
          
  
    <span>第一部分 基础入门</span>
  

          
  
  
  

  
  <ul>
    
      
        <li>
          
  
    <a href="/study-python/docs/basic/grammar/" class="collapsed ">1.1 语法</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/study-python/docs/basic/std/" class="collapsed ">1.2 标准库</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/study-python/docs/basic/spec/" class="collapsed ">1.3 编程规范</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/study-python/docs/basic/other/" class="collapsed ">1.4 其他</a>
  

          
  
  
  

  
  <ul>
    
      
        <li>
          
  
    <a href="/study-python/docs/basic/other/coroutine/" class="active">协程</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/study-python/docs/basic/other/version/" class="collapsed ">版本</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/study-python/docs/basic/other/package/" class="collapsed ">Package</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/study-python/docs/basic/other/anaconda/" class="">Anaconda</a>
  

        </li>
      
    
  </ul>
  

        </li>
      
    
  </ul>
  

        </li>
      
    
      
        <li>
          
  
    <span>第二部分 进阶实战</span>
  

          
  
  
  

  
  <ul>
    
      
        <li>
          
  
    <a href="/study-python/docs/advanced/pattern/" class="collapsed ">2.1 设计模式</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/study-python/docs/advanced/algs/" class="collapsed ">2.2 算法实现</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/study-python/docs/advanced/pkg/" class="collapsed ">2.3 常用库</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/study-python/docs/advanced/snippet/" class="collapsed ">2.4 代码片段</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/study-python/docs/advanced/test/" class="collapsed ">2.5 测试</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/study-python/docs/advanced/prof/" class="collapsed ">2.6 性能</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/study-python/docs/advanced/frame/" class="collapsed ">2.7 框架</a>
  

          
  
  
  

  

        </li>
      
    
  </ul>
  

        </li>
      
    
      
        <li>
          
  
    <span>第三部分 源码实现</span>
  

          
  
  
  

  
  <ul>
    
      
        <li>
          
  
    <a href="/study-python/docs/code/type/" class="collapsed ">3.1 数据类型</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/study-python/docs/code/keyword/" class="collapsed ">3.2 关键字</a>
  

          
  
  
  

  

        </li>
      
    
      
        <li>
          
  
    <a href="/study-python/docs/code/runtime/" class="collapsed ">3.3 运行时</a>
  

          
  
  
  

  

        </li>
      
    
  </ul>
  

        </li>
      
    
      
        <li>
          
  
    <span>第四部分 附录</span>
  

          
  
  
  

  
  <ul>
    
      
        <li>
          
  
    <a href="/study-python/docs/appendix/tutorial/" class="">4.1 教程</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/study-python/docs/appendix/interview/" class="">4.2 面试题</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/study-python/docs/appendix/attention/" class="">4.3 关注项目</a>
  

        </li>
      
    
  </ul>
  

        </li>
      
    
  </ul>
  














<hr />
<ul>
  <li><a href="https://cdn.jsdelivr.net/gh/ikingye/imagehost/picgo/20200417022040.png" target="_blank" rel="noopener noreferrer">微信</a></li>
  <li><a href="https://qm.qq.com/cgi-bin/qm/qr?k=EUhzg0UwUksxpQnwEmPngRLezlC6qrnn&jump_from=webapi" target="_blank" rel="noopener noreferrer"><img src="//pub.idqqimg.com/wpa/images/group.png"></a></li>
</ul>


</nav>




  <script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script>


 
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/study-python/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>协程</strong>

  <label for="toc-control">
    
    <img src="/study-python/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  <nav id="TableOfContents">
  <ul>
    <li><a href="#子程序就是协程的一种特例">子程序就是协程的一种特例</a></li>
    <li><a href="#geventhttpsgithubcomgeventgevent-github-starshttpsimgshieldsiogithubstarsgeventgeventsvg"><a href="https://github.com/gevent/gevent">gevent</a> <img src="https://img.shields.io/github/stars/gevent/gevent.svg" alt="Github stars"></a></li>
  </ul>
</nav>


  </aside>
  
 
      </header>

      
      
  <article class="markdown"><h1 id="python-协程">
  Python 协程
  <a class="anchor" href="#python-%e5%8d%8f%e7%a8%8b">#</a>
</h1>
<ul>
<li>执行效率高
<ul>
<li>子程序切换不是线程切换，而是由程序自身控制，因此，没有线程切换的开销，和多线程比，线程数量越多，协程的性能优势就越明显。</li>
<li>不需要多线程的锁机制，因为只有一个线程，也不存在同时写变量冲突，在协程中控制共享资源不加锁，只需要判断状态就好了</li>
</ul>
</li>
</ul>
<p>因为协程是一个线程执行，那怎么利用多核 CPU 呢？
最简单的方法是<strong>多进程 + 协程</strong>，既充分利用多核，又充分发挥协程的高效率，可获得极高的性能。</p>
<h2 id="子程序就是协程的一种特例">
  子程序就是协程的一种特例
  <a class="anchor" href="#%e5%ad%90%e7%a8%8b%e5%ba%8f%e5%b0%b1%e6%98%af%e5%8d%8f%e7%a8%8b%e7%9a%84%e4%b8%80%e7%a7%8d%e7%89%b9%e4%be%8b">#</a>
</h2>
<p>Donald Knuth 的一句话总结协程的特点：</p>
<p>“子程序就是协程的一种特例。”</p>
<a href="https://github.com/gevent/gevent">gevent</a> <h2 id="geventhttpsgithubcomgeventgevent-github-starshttpsimgshieldsiogithubstarsgeventgeventsvg">
  <img src="https://img.shields.io/github/stars/gevent/gevent.svg" alt="Github stars" />
  <a class="anchor" href="#geventhttpsgithubcomgeventgevent-github-starshttpsimgshieldsiogithubstarsgeventgeventsvg">#</a>
</h2>
<p>Python 通过 yield 提供了对协程的基本支持，但是不完全。而第三方的 gevent 为 Python 提供了比较完善的协程支持。</p>
<p>gevent 是第三方库，通过 greenlet 实现协程，其基本思想是：</p>
<p>当一个 greenlet 遇到 IO 操作时，比如访问网络，就自动切换到其他的 greenlet，等到 IO 操作完成，再在适当的时候切换回来继续执行。由于 IO 操作非常耗时，经常使程序处于等待状态，有了 gevent 为我们自动切换协程，就保证总有 greenlet 在运行，而不是等待 IO。</p>
<p>由于切换是在 IO 操作时自动完成，所以 gevent 需要修改 Python 自带的一些标准库，这一过程在启动时通过 <code>monkey patch</code> 完成：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> gevent <span style="color:#f92672">import</span> monkey; monkey<span style="color:#f92672">.</span>patch_socket()
<span style="color:#f92672">import</span> gevent

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">f</span>(n):
    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(n):
        <span style="color:#66d9ef">print</span> gevent<span style="color:#f92672">.</span>getcurrent(), i

g1 <span style="color:#f92672">=</span> gevent<span style="color:#f92672">.</span>spawn(f, <span style="color:#ae81ff">5</span>)
g2 <span style="color:#f92672">=</span> gevent<span style="color:#f92672">.</span>spawn(f, <span style="color:#ae81ff">5</span>)
g3 <span style="color:#f92672">=</span> gevent<span style="color:#f92672">.</span>spawn(f, <span style="color:#ae81ff">5</span>)
g1<span style="color:#f92672">.</span>join()
g2<span style="color:#f92672">.</span>join()
g3<span style="color:#f92672">.</span>join()
</code></pre></div><p>参考：</p>
<ul>
<li><a href="https://www.liaoxuefeng.com/wiki/897692888725344/923057403198272">Python 协程</a></li>
</ul>
<hr>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">



  <div><a class="flex align-center" href="https://github.com/ikingye/study-python/commit/8633d5a203d10d4baabaeb2bb94e547b2fe5a286" title='Last modified by yewang | 2020-07-14' target="_blank" rel="noopener">
      <img src="/study-python/svg/calendar.svg" class="book-icon" alt="Calendar" />
      <span>2020-07-14</span>
    </a>
  </div>



</div>

 
        <div>
    <br>
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.3.0/css/font-awesome.min.css">
    <p><span id="busuanzi_container_page_pv">本文访问量 <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span> 次</span></p>
    <p><span id="busuanzi_container_site_pv">本站总访问量 <span id="busuanzi_value_site_pv"><i class="fa fa-spinner fa-spin"></i></span> 次</span></p>
    <p><span id="busuanzi_container_site_uv">本站总访客数 <span id="busuanzi_value_site_uv"><i class="fa fa-spinner fa-spin"></i></span> 人次</span></p>
</div>


      </footer>

      
  
  <div class="book-comments">
<script src="https://utteranc.es/client.js"
  repo="ikingye/study-python"
  issue-term="pathname"
  theme="github-light"
  crossorigin="anonymous"
  async
></script>

<div id="footer">
  <p>
    <a href="https://kingye.me">叶王</a> &copy; 2013-2020
    版权所有。如果本文档对你有所帮助，可以<a
      href="https://cdn.jsdelivr.net/gh/ikingye/imagehost/picgo/20200428110046.png"
      target="_blank"
      rel="noopener noreferrer"
      >请作者喝饮料</a
    >。
  </p>
</div>

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#子程序就是协程的一种特例">子程序就是协程的一种特例</a></li>
    <li><a href="#geventhttpsgithubcomgeventgevent-github-starshttpsimgshieldsiogithubstarsgeventgeventsvg"><a href="https://github.com/gevent/gevent">gevent</a> <img src="https://img.shields.io/github/stars/gevent/gevent.svg" alt="Github stars"></a></li>
  </ul>
</nav>

 
    </aside>
    
  </main>

  
</body>

</html>












