<!doctype html><html lang=en dir=ltr><head><meta name=generator content="Hugo 0.151.0"><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="
  Python 协程
  
  #
  


执行效率高

子程序切换不是线程切换，而是由程序自身控制，因此，没有线程切换的开销，和多线程比，线程数量越多，协程的性能优势就越明显。
不需要多线程的锁机制，因为只有一个线程，也不存在同时写变量冲突，在协程中控制共享资源不加锁，只需要判断状态就好了



因为协程是一个线程执行，那怎么利用多核 CPU 呢？
最简单的方法是多进程 + 协程，既充分利用多核，又充分发挥协程的高效率，可获得极高的性能。

  子程序就是协程的一种特例
  
  #
  

Donald Knuth 的一句话总结协程的特点：
“子程序就是协程的一种特例。”

  gevent 
  
  #
  

Python 通过 yield 提供了对协程的基本支持，但是不完全。而第三方的 gevent 为 Python 提供了比较完善的协程支持。
gevent 是第三方库，通过 greenlet 实现协程，其基本思想是：
当一个 greenlet 遇到 IO 操作时，比如访问网络，就自动切换到其他的 greenlet，等到 IO 操作完成，再在适当的时候切换回来继续执行。由于 IO 操作非常耗时，经常使程序处于等待状态，有了 gevent 为我们自动切换协程，就保证总有 greenlet 在运行，而不是等待 IO。
由于切换是在 IO 操作时自动完成，所以 gevent 需要修改 Python 自带的一些标准库，这一过程在启动时通过 monkey patch 完成：
from gevent import monkey; monkey.patch_socket()
import gevent

def f(n):
    for i in range(n):
        print gevent.getcurrent(), i

g1 = gevent.spawn(f, 5)
g2 = gevent.spawn(f, 5)
g3 = gevent.spawn(f, 5)
g1.join()
g2.join()
g3.join()
参考："><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://kingye.me/study-python/docs/basic/other/coroutine/"><meta property="og:site_name" content="Python 学习笔记"><meta property="og:title" content="协程"><meta property="og:description" content="Python 协程 # 执行效率高 子程序切换不是线程切换，而是由程序自身控制，因此，没有线程切换的开销，和多线程比，线程数量越多，协程的性能优势就越明显。 不需要多线程的锁机制，因为只有一个线程，也不存在同时写变量冲突，在协程中控制共享资源不加锁，只需要判断状态就好了 因为协程是一个线程执行，那怎么利用多核 CPU 呢？ 最简单的方法是多进程 + 协程，既充分利用多核，又充分发挥协程的高效率，可获得极高的性能。
子程序就是协程的一种特例 # Donald Knuth 的一句话总结协程的特点：
“子程序就是协程的一种特例。”
gevent # Python 通过 yield 提供了对协程的基本支持，但是不完全。而第三方的 gevent 为 Python 提供了比较完善的协程支持。
gevent 是第三方库，通过 greenlet 实现协程，其基本思想是：
当一个 greenlet 遇到 IO 操作时，比如访问网络，就自动切换到其他的 greenlet，等到 IO 操作完成，再在适当的时候切换回来继续执行。由于 IO 操作非常耗时，经常使程序处于等待状态，有了 gevent 为我们自动切换协程，就保证总有 greenlet 在运行，而不是等待 IO。
由于切换是在 IO 操作时自动完成，所以 gevent 需要修改 Python 自带的一些标准库，这一过程在启动时通过 monkey patch 完成：
from gevent import monkey; monkey.patch_socket() import gevent def f(n): for i in range(n): print gevent.getcurrent(), i g1 = gevent.spawn(f, 5) g2 = gevent.spawn(f, 5) g3 = gevent.spawn(f, 5) g1.join() g2.join() g3.join() 参考："><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2020-07-14T23:41:45+08:00"><title>协程 | Python 学习笔记</title><link rel=icon href=/study-python/favicon.png><link rel=manifest href=/study-python/manifest.json><link rel=canonical href=https://kingye.me/study-python/docs/basic/other/coroutine/><link rel=stylesheet href=/study-python/book.min.9621801c2d1bcb3ffdd0a8827994f5daf4cca688a7aa735691ad70419b629153.css integrity="sha256-liGAHC0byz/90KiCeZT12vTMpoinqnNWka1wQZtikVM=" crossorigin=anonymous><script defer src=/study-python/fuse.min.js></script><script defer src=/study-python/en.search.min.af801758d923fe609b57c619bbce9fabe494bd39058a30991bf3a5f93d8d60e6.js integrity="sha256-r4AXWNkj/mCbV8YZu86fq+SUvTkFijCZG/Ol+T2NYOY=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/study-python/><span>Python 学习笔记</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><ul><li><a href=https://kingye.me target=_blank rel="noopener noreferrer">博客</a></li><li><a href=https://cdn.jsdelivr.net/gh/ikingye/imagehost/picgo/20200417021727.png target=_blank rel="noopener noreferrer">公众号</a></li><li><a href=https://github.com/ikingye target=_blank rel="noopener noreferrer">Github</a></li><li><a href=https://weibo.com/kingyip15215 target=_blank rel="noopener noreferrer">微博</a></li><li><a href=https://www.zhihu.com/people/wutongyip target=_blank rel="noopener noreferrer">知乎</a></li></ul><hr><ul><li><a href=/study-python/docs/basic/>第一部分 基础入门</a><ul><li><input type=checkbox id=section-375349b50a60cfb36b08a7e1edd911a8 class=toggle>
<label for=section-375349b50a60cfb36b08a7e1edd911a8 class=flex><a href=/study-python/docs/basic/grammar/ class=flex-auto>1.1 语法</a></label><ul><li><input type=checkbox id=section-bf2e904b8d3f38f3ab19e84b38e92ab4 class=toggle>
<label for=section-bf2e904b8d3f38f3ab19e84b38e92ab4 class=flex><a href=/study-python/docs/basic/grammar/builtin/ class=flex-auto>内建函数</a></label></li><li><input type=checkbox id=section-6d38c082cdb7d181fcb70d0d98272bb9 class=toggle>
<label for=section-6d38c082cdb7d181fcb70d0d98272bb9 class=flex><a href=/study-python/docs/basic/grammar/function/ class=flex-auto>函数</a></label><ul><li><input type=checkbox id=section-5c0ee4586de69e0d64f0e57d7cecc9c8 class=toggle>
<label for=section-5c0ee4586de69e0d64f0e57d7cecc9c8 class=flex><a href=/study-python/docs/basic/grammar/function/decorator/ class=flex-auto>装饰器</a></label></li></ul></li><li><a href=/study-python/docs/basic/grammar/slice/>切片</a></li><li><a href=/study-python/docs/basic/grammar/dict/>字典</a></li><li><input type=checkbox id=section-967a1ec7cdc056cd4acbba263ebd969f class=toggle>
<label for=section-967a1ec7cdc056cd4acbba263ebd969f class=flex><a href=/study-python/docs/basic/grammar/generator/ class=flex-auto>生成器</a></label></li><li><a href=/study-python/docs/basic/grammar/class/>类</a></li></ul></li><li><input type=checkbox id=section-d28ef8ab5ce546b8df8f31a9113e1803 class=toggle>
<label for=section-d28ef8ab5ce546b8df8f31a9113e1803 class=flex><a href=/study-python/docs/basic/std/ class=flex-auto>1.2 标准库</a></label><ul></ul></li><li><input type=checkbox id=section-73b4036a0484b46c65592e82785676de class=toggle>
<label for=section-73b4036a0484b46c65592e82785676de class=flex><a href=/study-python/docs/basic/import/ class=flex-auto>import</a></label></li><li><input type=checkbox id=section-bf1df623aabbf39706c48be11cedbecd class=toggle>
<label for=section-bf1df623aabbf39706c48be11cedbecd class=flex><a href=/study-python/docs/basic/file/ class=flex-auto>python 文件</a></label></li><li><input type=checkbox id=section-4fe6fcdc37b8a67e32fe01de188e13b5 class=toggle>
<label for=section-4fe6fcdc37b8a67e32fe01de188e13b5 class=flex><a href=/study-python/docs/basic/spec/ class=flex-auto>1.3 编程规范</a></label><ul></ul></li><li><input type=checkbox id=section-5148b85fe59153263ddec51e13709a2c class=toggle checked>
<label for=section-5148b85fe59153263ddec51e13709a2c class=flex><a href=/study-python/docs/basic/other/ class=flex-auto>1.4 其他</a></label><ul><li><input type=checkbox id=section-e12e40bf0172d88d1d71088da0520086 class=toggle checked>
<label for=section-e12e40bf0172d88d1d71088da0520086 class=flex><a href=/study-python/docs/basic/other/coroutine/ class="flex-auto active">协程</a></label></li><li><input type=checkbox id=section-64886a7346e3db37cc86480f7e922b85 class=toggle>
<label for=section-64886a7346e3db37cc86480f7e922b85 class=flex><a href=/study-python/docs/basic/other/version/ class=flex-auto>版本</a></label><ul><li><a href=/study-python/docs/basic/other/version/manage/>版本管理</a></li><li><a href=/study-python/docs/basic/other/version/3.7/>3.7</a></li></ul></li><li><input type=checkbox id=section-f675fb7ddcdcbd4c9558da040c3473c6 class=toggle>
<label for=section-f675fb7ddcdcbd4c9558da040c3473c6 class=flex><a href=/study-python/docs/basic/other/package/ class=flex-auto>Package</a></label><ul><li><a href=/study-python/docs/basic/other/package/manage/>包管理</a></li><li><input type=checkbox id=section-f78317bac90f2e5a75ed9e48ff29d8cc class=toggle>
<label for=section-f78317bac90f2e5a75ed9e48ff29d8cc class=flex><a href=/study-python/docs/basic/other/package/common/ class=flex-auto>常用</a></label><ul></ul></li></ul></li><li><input type=checkbox id=section-e5d30893b2ea4e84fdd9a7c03a128bbc class=toggle>
<label for=section-e5d30893b2ea4e84fdd9a7c03a128bbc class=flex><a href=/study-python/docs/basic/other/anaconda/ class=flex-auto>Anaconda</a></label></li></ul></li></ul></li><li><span>第二部分 进阶实战</span><ul><li><input type=checkbox id=section-fd118645e19c166a5d6ebf5b2d4c85e6 class=toggle>
<label for=section-fd118645e19c166a5d6ebf5b2d4c85e6 class=flex><a href=/study-python/docs/advanced/pattern/ class=flex-auto>2.1 设计模式</a></label><ul></ul></li><li><input type=checkbox id=section-81ae623569b0f6d249f9a689d7526f5f class=toggle>
<label for=section-81ae623569b0f6d249f9a689d7526f5f class=flex><a href=/study-python/docs/advanced/algs/ class=flex-auto>2.2 算法实现</a></label><ul></ul></li><li><input type=checkbox id=section-39ae031a8f3032ce271703709ffca8c2 class=toggle>
<label for=section-39ae031a8f3032ce271703709ffca8c2 class=flex><a href=/study-python/docs/advanced/pkg/ class=flex-auto>2.3 常用库</a></label><ul></ul></li><li><input type=checkbox id=section-0e758794d338ab4e27080a3b6bea58b8 class=toggle>
<label for=section-0e758794d338ab4e27080a3b6bea58b8 class=flex><a href=/study-python/docs/advanced/snippet/ class=flex-auto>2.4 代码片段</a></label><ul></ul></li><li><input type=checkbox id=section-37e520434b6b673cb3ef13ea89e09114 class=toggle>
<label for=section-37e520434b6b673cb3ef13ea89e09114 class=flex><a href=/study-python/docs/advanced/test/ class=flex-auto>2.5 测试</a></label><ul></ul></li><li><input type=checkbox id=section-db1bcc02077d0bb6104503ade8a7535a class=toggle>
<label for=section-db1bcc02077d0bb6104503ade8a7535a class=flex><a href=/study-python/docs/advanced/prof/ class=flex-auto>2.6 性能</a></label><ul></ul></li><li><input type=checkbox id=section-e739e793b644f1337583888a5b1067bb class=toggle>
<label for=section-e739e793b644f1337583888a5b1067bb class=flex><a href=/study-python/docs/advanced/frame/ class=flex-auto>2.7 框架</a></label><ul></ul></li></ul></li><li><span>第三部分 源码实现</span><ul><li><input type=checkbox id=section-e2fa5571f42dffd378aace203b5fe7fc class=toggle>
<label for=section-e2fa5571f42dffd378aace203b5fe7fc class=flex><a href=/study-python/docs/code/type/ class=flex-auto>3.1 数据类型</a></label><ul></ul></li><li><input type=checkbox id=section-4dfabf871fdb326653391081035dd56a class=toggle>
<label for=section-4dfabf871fdb326653391081035dd56a class=flex><a href=/study-python/docs/code/keyword/ class=flex-auto>3.2 关键字</a></label><ul></ul></li><li><input type=checkbox id=section-6f00032b802968588b16ce2b3a411690 class=toggle>
<label for=section-6f00032b802968588b16ce2b3a411690 class=flex><a href=/study-python/docs/code/runtime/ class=flex-auto>3.3 运行时</a></label><ul></ul></li></ul></li><li><span>第四部分 附录</span><ul><li><input type=checkbox id=section-9146926543c8f956eea149c90d69c4e7 class=toggle>
<label for=section-9146926543c8f956eea149c90d69c4e7 class=flex><a href=/study-python/docs/appendix/tutorial/ class=flex-auto>4.1 教程</a></label></li><li><input type=checkbox id=section-22db811ce1155f2f9de5f0933e6cdaeb class=toggle>
<label for=section-22db811ce1155f2f9de5f0933e6cdaeb class=flex><a href=/study-python/docs/appendix/interview/ class=flex-auto>4.2 面试题</a></label></li><li><input type=checkbox id=section-049d24d630ab01924a2d70f5fa34a71e class=toggle>
<label for=section-049d24d630ab01924a2d70f5fa34a71e class=flex><a href=/study-python/docs/appendix/attention/ class=flex-auto>4.3 关注项目</a></label></li></ul></li></ul><hr><ul><li><a href=https://cdn.jsdelivr.net/gh/ikingye/imagehost/picgo/20200417022040.png target=_blank rel="noopener noreferrer">微信</a></li><li><a href="https://qm.qq.com/cgi-bin/qm/qr?k=EUhzg0UwUksxpQnwEmPngRLezlC6qrnn&jump_from=webapi" target=_blank rel="noopener noreferrer"><img src=//pub.idqqimg.com/wpa/images/group.png></a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/study-python/svg/menu.svg class=book-icon alt=Menu></label><h3>协程</h3><label for=toc-control><img src=/study-python/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#子程序就是协程的一种特例>子程序就是协程的一种特例</a></li><li><a href=#gevent-github-stars>gevent <img src=https://img.shields.io/github/stars/gevent/gevent.svg alt="Github stars"></a></li></ul></nav></aside></header><article id=article class=markdown><h1 id=python-协程>Python 协程
<a class=anchor href=#python-%e5%8d%8f%e7%a8%8b>#</a></h1><ul><li>执行效率高<ul><li>子程序切换不是线程切换，而是由程序自身控制，因此，没有线程切换的开销，和多线程比，线程数量越多，协程的性能优势就越明显。</li><li>不需要多线程的锁机制，因为只有一个线程，也不存在同时写变量冲突，在协程中控制共享资源不加锁，只需要判断状态就好了</li></ul></li></ul><p>因为协程是一个线程执行，那怎么利用多核 CPU 呢？
最简单的方法是<strong>多进程 + 协程</strong>，既充分利用多核，又充分发挥协程的高效率，可获得极高的性能。</p><h2 id=子程序就是协程的一种特例>子程序就是协程的一种特例
<a class=anchor href=#%e5%ad%90%e7%a8%8b%e5%ba%8f%e5%b0%b1%e6%98%af%e5%8d%8f%e7%a8%8b%e7%9a%84%e4%b8%80%e7%a7%8d%e7%89%b9%e4%be%8b>#</a></h2><p>Donald Knuth 的一句话总结协程的特点：</p><p>“子程序就是协程的一种特例。”</p><h2 id=gevent-github-stars><a href=https://github.com/gevent/gevent>gevent</a> <img src=https://img.shields.io/github/stars/gevent/gevent.svg alt="Github stars">
<a class=anchor href=#gevent-github-stars>#</a></h2><p>Python 通过 yield 提供了对协程的基本支持，但是不完全。而第三方的 gevent 为 Python 提供了比较完善的协程支持。</p><p>gevent 是第三方库，通过 greenlet 实现协程，其基本思想是：</p><p>当一个 greenlet 遇到 IO 操作时，比如访问网络，就自动切换到其他的 greenlet，等到 IO 操作完成，再在适当的时候切换回来继续执行。由于 IO 操作非常耗时，经常使程序处于等待状态，有了 gevent 为我们自动切换协程，就保证总有 greenlet 在运行，而不是等待 IO。</p><p>由于切换是在 IO 操作时自动完成，所以 gevent 需要修改 Python 自带的一些标准库，这一过程在启动时通过 <code>monkey patch</code> 完成：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> gevent <span style=color:#f92672>import</span> monkey; monkey<span style=color:#f92672>.</span>patch_socket()
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> gevent
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>f</span>(n):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(n):
</span></span><span style=display:flex><span>        print gevent<span style=color:#f92672>.</span>getcurrent(), i
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>g1 <span style=color:#f92672>=</span> gevent<span style=color:#f92672>.</span>spawn(f, <span style=color:#ae81ff>5</span>)
</span></span><span style=display:flex><span>g2 <span style=color:#f92672>=</span> gevent<span style=color:#f92672>.</span>spawn(f, <span style=color:#ae81ff>5</span>)
</span></span><span style=display:flex><span>g3 <span style=color:#f92672>=</span> gevent<span style=color:#f92672>.</span>spawn(f, <span style=color:#ae81ff>5</span>)
</span></span><span style=display:flex><span>g1<span style=color:#f92672>.</span>join()
</span></span><span style=display:flex><span>g2<span style=color:#f92672>.</span>join()
</span></span><span style=display:flex><span>g3<span style=color:#f92672>.</span>join()
</span></span></code></pre></div><p>参考：</p><ul><li><a href=https://www.liaoxuefeng.com/wiki/897692888725344/923057403198272>Python 协程</a></li></ul><hr></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><div class="flex flex-wrap justify-between"><span><a href=/study-python/docs/basic/other/ class="flex align-center"><img src=/study-python/svg/backward.svg class=book-icon alt=Previous title="1.4 其他">
<span>1.4 其他</span>
</a></span><span><a href=/study-python/docs/basic/other/version/ class="flex align-center"><span>版本</span>
<img src=/study-python/svg/forward.svg class=book-icon alt=Next title=版本></a></span></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script><div><br><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><link rel=stylesheet href=//cdn.bootcss.com/font-awesome/4.3.0/css/font-awesome.min.css><p><span id=busuanzi_container_page_pv>本文访问量 <span id=busuanzi_value_page_pv><i class="fa fa-spinner fa-spin"></i></span> 次</span></p><p><span id=busuanzi_container_site_pv>本站总访问量 <span id=busuanzi_value_site_pv><i class="fa fa-spinner fa-spin"></i></span> 次</span></p><p><span id=busuanzi_container_site_uv>本站总访客数 <span id=busuanzi_value_site_uv><i class="fa fa-spinner fa-spin"></i></span> 人</span></p></div></footer><div class=book-comments><script src=https://utteranc.es/client.js repo=ikingye/study-python issue-term=pathname theme=github-light crossorigin=anonymous async></script><div id=footer><p><a href=https://kingye.me>叶王</a> &copy; 2013-2026
版权所有。如果本文档对你有所帮助，可以<a href=https://cdn.jsdelivr.net/gh/ikingye/imagehost/picgo/20200428110046.png target=_blank rel="noopener noreferrer">请作者喝饮料</a>。</p></div></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#子程序就是协程的一种特例>子程序就是协程的一种特例</a></li><li><a href=#gevent-github-stars>gevent <img src=https://img.shields.io/github/stars/gevent/gevent.svg alt="Github stars"></a></li></ul></nav></div></aside></main></body></html>